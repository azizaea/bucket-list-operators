generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// OPERATORS & USERS
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  guides Guide[]

  @@map("users")
}

model Operator {
  id                  String   @id @default(uuid())
  companyNameAr       String   @map("company_name_ar")
  companyNameEn       String   @map("company_name_en")
  licenseNumber       String   @unique @map("license_number")
  email               String   @unique
  phone               String
  subscriptionPlan    String   @default("starter") @map("subscription_plan") // starter, growth, enterprise
  subscriptionStatus  String   @default("active") @map("subscription_status")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  users                 OperatorUser[]
  tours                 Tour[]
  resources             Resource[]
  ministryReports       MinistryReport[]
  tourGuideAssignments  TourGuideAssignment[]
  guides                Guide[]

  @@map("operators")
}

model OperatorUser {
  id           String   @id @default(uuid())
  operatorId   String   @map("operator_id")
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         String   // admin, staff, agent
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  operator     Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@map("operator_users")
}

// ============================================
// TOURS & SCHEDULES
// ============================================

model Tour {
  id                      String   @id @default(uuid())
  operatorId              String   @map("operator_id")
  titleAr                 String   @map("title_ar")
  titleEn                 String   @map("title_en")
  descriptionAr           String?  @map("description_ar") @db.Text
  descriptionEn           String?  @map("description_en") @db.Text
  durationHours           Int      @map("duration_hours")
  maxCapacity             Int      @map("max_capacity")
  basePriceSar            Decimal  @map("base_price_sar") @db.Decimal(10, 2)
  category                String   // cultural, adventure, desert, city, etc.
  highlights              String[] @default([])
  inclusions              String[] @default([])
  exclusions              String[] @default([])
  meetingPoint            String?  @map("meeting_point") @db.Text
  meetingPointInstructions String? @map("meeting_point_instructions") @db.Text
  importantNotes          String?  @map("important_notes") @db.Text
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  operator             Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  schedules            TourSchedule[]
  tourGuideAssignments TourGuideAssignment[]

  @@map("tours")
}

model TourSchedule {
  id                String   @id @default(uuid())
  tourId            String   @map("tour_id")
  departureDatetime DateTime @map("departure_datetime")
  availableSpots    Int      @map("available_spots")
  priceOverride     Decimal? @map("price_override") @db.Decimal(10, 2)
  status            String   @default("available") // available, full, cancelled
  createdAt         DateTime @default(now()) @map("created_at")

  tour              Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)
  bookings          Booking[]
  resourceAssignments ResourceAssignment[]

  @@map("tour_schedules")
}

// ============================================
// BOOKINGS
// ============================================

model Booking {
  id                String   @id @default(uuid())
  scheduleId        String   @map("schedule_id")
  customerName      String   @map("customer_name")
  customerEmail     String   @map("customer_email")
  customerPhone     String   @map("customer_phone")
  numGuests         Int      @map("num_guests")
  totalPriceSar     Decimal  @map("total_price_sar") @db.Decimal(10, 2)
  bookingStatus     String   @default("pending") @map("booking_status") // pending, confirmed, cancelled, completed
  paymentStatus     String   @default("unpaid") @map("payment_status") // unpaid, paid, refunded
  bookingReference  String   @unique @map("booking_reference")
  bookingNotes      String?  @map("booking_notes") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  schedule          TourSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  guests            BookingGuest[]
  payment           Payment?

  @@map("bookings")
}

model BookingGuest {
  id              String   @id @default(uuid())
  bookingId       String   @map("booking_id")
  guestName       String   @map("guest_name")
  guestAge        Int?     @map("guest_age")
  guestNationality String? @map("guest_nationality")
  waiverSigned    Boolean  @default(false) @map("waiver_signed")
  checkedIn       Boolean  @default(false) @map("checked_in")
  createdAt       DateTime @default(now()) @map("created_at")

  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_guests")
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id              String   @id @default(uuid())
  bookingId       String   @unique @map("booking_id")
  paymentGateway  String   @map("payment_gateway") // moyasar, sadad, etc.
  amountSar       Decimal  @map("amount_sar") @db.Decimal(10, 2)
  transactionId   String?  @map("transaction_id")
  paymentStatus   String   @default("pending") @map("payment_status") // pending, completed, failed, refunded
  paymentMethod   String?  @map("payment_method") // mada, visa, apple_pay
  paymentDate     DateTime? @map("payment_date")
  webhookData     Json?    @map("webhook_data")
  createdAt       DateTime @default(now()) @map("created_at")

  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================
// RESOURCES (Guides, Vehicles, Equipment)
// ============================================

model Resource {
  id                   String   @id @default(uuid())
  operatorId           String   @map("operator_id")
  resourceType         String   @map("resource_type") // guide, vehicle, equipment
  resourceName         String   @map("resource_name")
  externalId           String?  @map("external_id") // Link to Desert Rose guide
  maxDailyAssignments  Int      @default(1) @map("max_daily_assignments")
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")

  operator             Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  assignments          ResourceAssignment[]

  @@map("resources")
}

model ResourceAssignment {
  id           String   @id @default(uuid())
  resourceId   String   @map("resource_id")
  scheduleId   String   @map("schedule_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  resource     Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  schedule     TourSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([resourceId, scheduleId])
  @@map("resource_assignments")
}

// ============================================
// MINISTRY COMPLIANCE
// ============================================

model MinistryReport {
  id           String   @id @default(uuid())
  operatorId   String   @map("operator_id")
  reportType   String   @map("report_type") // monthly_bookings, revenue, demographics
  reportPeriod String   @map("report_period") // 2026-01, 2026-Q1
  reportData   Json     @map("report_data")
  submittedAt  DateTime? @map("submitted_at")
  createdAt    DateTime @default(now()) @map("created_at")

  operator     Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@map("ministry_reports")
}

// ============================================
// GUIDE MANAGEMENT
// ============================================

model Guide {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  operatorId      String?  @map("operator_id")
  fullName        String   @map("full_name")
  phone           String
  email           String
  licenseNumber   String   @map("license_number")
  licensePhotoUrl String?  @map("license_photo_url")
  profilePictureUrl String?  @map("profile_picture_url")
  licenseStatus   GuideLicenseStatus @default(NONE) @map("license_status")
  languages       String[] @default([])
  specialties     String[] @default([])
  location        String
  bio             String?  @db.Text
  rating          Decimal? @db.Decimal(3, 2)
  hourlyRate      Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  availability    Json?    // calendar data
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  operator          Operator?            @relation(fields: [operatorId], references: [id], onDelete: SetNull)
  tourGuideAssignments TourGuideAssignment[]
  itineraries       GuideItinerary[]

  @@map("guides")
}

enum GuideLicenseStatus {
  NONE
  PENDING
  VERIFIED
}

model TourGuideAssignment {
  id          String   @id @default(uuid())
  tourId      String   @map("tour_id")
  guideId     String   @map("guide_id")
  operatorId  String   @map("operator_id")
  status      TourGuideAssignmentStatus @default(PENDING)
  assignedAt  DateTime @default(now()) @map("assigned_at")
  respondedAt DateTime? @map("responded_at")
  tourDate    DateTime @map("tour_date")
  payRate     Decimal? @map("pay_rate") @db.Decimal(10, 2)
  notes       String?  @db.Text

  tour    Tour    @relation(fields: [tourId], references: [id], onDelete: Cascade)
  guide   Guide   @relation(fields: [guideId], references: [id], onDelete: Cascade)
  operator Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@map("tour_guide_assignments")
}

enum TourGuideAssignmentStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
}

model GuideItinerary {
  id                String   @id @default(uuid())
  guideId           String   @map("guide_id")
  title             String
  destinations      Json     // array of stops
  estimatedDuration Int      @map("estimated_duration") // minutes
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  guide Guide @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@map("guide_itineraries")
}
